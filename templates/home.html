{% extends "base.html" %}
{% block title %}Home – OTA Cache & Import{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">OTA – Cache e Import</h3>
</div>

<div class="row g-4">

    <!-- COLONNA SINISTRA: IMPORT / CACHE -->
    <div class="col-12 col-lg-8">

        <!-- Product Cache Importer -->
        <div class="card shadow-sm">
            <div class="card-header">Product Cache Importer</div>
            <div class="card-body">
                <form id="updateSyncForm" method="get" action="{{ url_for('products.ota_update_products') }}"
                      data-spinner="Import running..." class="row gy-2 gx-3">

                    <div class="col-6 col-md-6">
                        <label class="form-label">Limit (opz.)</label>
                        <input type="number" name="limit" class="form-control"
                               min="1" step="1" inputmode="numeric"
                               value="{{ request.args.get('limit')}}" placeholder="es. 10">
                    </div>

                    <!-- Import completo: dettagli + immagini -->
                    <input type="hidden" name="fill_details" value="1">
                    <input type="hidden" name="maxcores" value="999">

                    <div class="col-auto d-flex align-items-center mt-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="debug" name="debug" value="1">
                            <label class="form-check-label" for="debug">Debug</label>
                        </div>
                    </div>

                    <!-- CTA PRODUCT -->
                    <div id="prod-cta-row" class="col-12 cta-row mt-2">
                        <button class="btn btn-warning btn-same" type="submit">Import completo</button>
                        <button class="btn btn-danger btn-same"
                                type="submit" form="clearProductsForm"
                                onclick="return confirm('Confermi di cancellare tutta la cache prodotti?');">
                            Delete
                        </button>
                        <a class="btn btn-info btn-same" href="{{ url_for('products.ota_products') }}"
                           data-spinner="Opening Products ...">View Products</a>

                        <!-- spinner inline per PRODUCT -->
                        <div id="prod-spinner" class="d-none d-flex align-items-center ms-auto">
                            <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                            <span>Working…</span>
                        </div>
                    </div>

                    <div class="col-12">
                        <small class="text-muted">Endpoint: <code>/products.ota_update_products?fill_details=1&maxcores=999</code></small>
                    </div>
                </form>
                <!-- form nascosto per Delete prodotti -->
                <form id="clearProductsForm" method="post" action="{{ url_for('admin.clear_products_cache') }}"></form>
            </div>
        </div>

        <!-- Departure Cache Importer -->
        <div class="card shadow-sm mt-3">
            <div class="card-header">Departure Cache Importer</div>
            <div class="card-body">
                <div class="row gy-2 gx-3">
                    <div class="col-12">
                        <label class="form-label">Folder JSON (opz.)</label>
                        <input id="dep_json_dir" class="form-control" placeholder="es. data/downloads">
                    </div>

                    <!-- CTA DEPARTURES -->
                    <div id="dep-cta-row" class="col-12 cta-row mt-2">
                        <a href="{{ url_for('admin.download_departures_zip') }}"
                           class="btn btn-secondary btn-same"
                           data-spinner="Downloading and uncompress in tmp folder">Download</a>

                        <button id="btn-start-dep" class="btn btn-primary btn-same" type="button">Import</button>

                        <button class="btn btn-danger btn-same" type="submit" form="clearDeparturesForm"
                                onclick="return confirm('Confermi di cancellare tutta la cache partenze?');">
                            Delete
                        </button>
                    </div>

                    <!-- PROGRESS BAR -->
                    <div class="col-12 mt-2">
                        <div class="progress" style="height:10px;">
                            <div id="dep-progress-bar" class="progress-bar" role="progressbar"
                                 style="width:0%;" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>

                    <!-- SPINNER + TESTO SOTTO LA BARRA -->
                    <div class="col-12 mt-2 d-none align-items-center" id="dep-spinner">
                        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                        <span id="dep-progress-text">Preparazione…</span>
                    </div>

                    <div class="col-12">
                        <small id="dep-msg" class="text-muted"></small>
                    </div>
                </div>
                <!-- form nascosto per Delete partenze -->
                <form id="clearDeparturesForm" method="post" action="{{ url_for('admin.clear_departures_cache') }}"></form>
            </div>
        </div>

        <!-- CARD: Mapping WooCommerce -->
        <div class="card shadow-sm mt-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <h5 class="card-title mb-2">Mapping prodotti WordPress</h5>
                    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('admin.wpmap_view') }}">View mapping</a>
                </div>

                <p class="text-muted small mb-3">
                    Importa il CSV esportato da WooCommerce per aggiornare il mapping locale.
                </p>

                <!-- Form: Import CSV -->
                <form class="d-flex flex-column gap-2"
                      action="{{ url_for('admin.wpmap_import') }}"
                      method="post" enctype="multipart/form-data">
                    <div class="form-text">Seleziona il file CSV di export prodotti WooCommerce.</div>
                    <input class="form-control" type="file" name="wp_csv" accept=".csv" required>

                    <div class="d-flex gap-2">
                        <button class="btn btn-success" type="submit">Importa CSV</button>

                        <!-- Il bottone sotto spara un submit su un form SEPARATO (niente annidamento) -->
                        <button class="btn btn-outline-danger" type="submit" form="formWpMapClear"
                                onclick="return confirm('Sicuro di svuotare il mapping?');">
                            Svuota mapping
                        </button>
                    </div>
                </form>

                <!-- Form separato per "Svuota mapping" -->
                <form id="formWpMapClear" action="{{ url_for('admin.wpmap_clear') }}" method="post"></form>
            </div>
        </div>

    </div>

</div>

<!-- JS identico al tuo (polling/progress/spinner/reset) -->
<script>
  function showFlex(el){ if(!el) return; el.classList.remove('d-none'); el.classList.add('d-flex'); }
  function hideEl(el){ if(!el) return; el.classList.remove('d-flex'); el.classList.add('d-none'); }

  (function () {
    const btn  = document.getElementById('btn-start-dep');
    const spin = document.getElementById('dep-spinner');
    const text = document.getElementById('dep-progress-text');
    const msg  = document.getElementById('dep-msg');
    const bar  = document.getElementById('dep-progress-bar');

    const URL_START = "{{ url_for('imports.start_import') }}";
    const URL_PROG  = "{{ url_for('imports.get_progress') }}";

    let timer = null;

    function setBar(done, total) {
      let pct = 0;
      if (total > 0) pct = Math.max(0, Math.min(100, Math.round((done / total) * 100)));
      bar.style.width = pct + '%';
      bar.setAttribute('aria-valuenow', pct);
    }

    async function pollDepProgress() {
      try {
        const r = await fetch(URL_PROG, { cache: 'no-store', credentials: 'same-origin' });
        if (!r.ok) { msg.textContent = `Progress HTTP ${r.status}`; return; }
        const p = await r.json();

        if (p.running) {
          showFlex(spin);
          if (btn) btn.disabled = true;

          const total = p.total || 0, done = p.done || 0;
          const base  = (total > 0) ? `Importing ${done} / ${total} file…` : 'Scansione file…';
          const file  = p.current_file ? ` — ${p.current_file}` : '';
          const tail  = p.last_msg ? ` — ${p.last_msg}` : '';
          text.textContent = base + file + tail;
          if (p.rows) msg.textContent = `Righe importate: ${p.rows}`;
          setBar(done, total);
        } else {
          if (timer) { clearInterval(timer); timer = null; }
          if (btn) btn.disabled = false;
          text.textContent = p.error ? 'Errore durante l’import.' : `Completato. Righe aggiornate: ${p.rows || 0}`;
          msg.textContent  = p.finished_at ? `Finito alle ${p.finished_at}` : '';
          setBar(p.done || 0, p.total || 0);
          setTimeout(() => { hideEl(spin); }, 600);
        }
      } catch (e) {
        msg.textContent = `Progress network error: ${e}`;
        console.error(e);
      }
    }

    if (btn) {
      btn.addEventListener('click', async () => {
        msg.textContent = ''; text.textContent = 'Avvio…';
        showFlex(spin); btn.disabled = true;

        try {
          const r = await fetch(URL_START, { method: 'POST', credentials: 'same-origin' });
          if (r.status === 202 || r.status === 409) {
            timer && clearInterval(timer);
            timer = setInterval(pollDepProgress, 700);
            return;
          }
          msg.textContent = `Errore ${r.status}`;
          hideEl(spin); btn.disabled = false;
        } catch (e) {
          msg.textContent = `Network error: ${e}`;
          hideEl(spin); btn.disabled = false;
        }
      });
    }
  })();

  (function () {
    const prodDelForm = document.getElementById('clearProductsForm');
    const prodRow     = document.getElementById('prod-cta-row');
    const prodSpin    = document.getElementById('prod-spinner');
    if (prodDelForm && prodRow && prodSpin) {
      prodDelForm.addEventListener('submit', function () {
        prodSpin.querySelector('span').textContent = 'Deleting…';
        prodSpin.classList.remove('d-none');
        prodRow.querySelectorAll('button, a.btn').forEach(el => {
          el.classList.add('disabled'); el.setAttribute('aria-disabled', 'true');
        });
      });
    }

    const depDelForm = document.getElementById('clearDeparturesForm');
    const depRow     = document.getElementById('dep-cta-row');
    const depSpin    = document.getElementById('dep-spinner');
    const depText    = document.getElementById('dep-progress-text');
    if (depDelForm && depRow && depSpin && depText) {
      depDelForm.addEventListener('submit', function () {
        depText.textContent = 'Deleting…';
        showFlex(depSpin);
        depRow.querySelectorAll('button, a.btn').forEach(el => {
          el.classList.add('disabled'); el.setAttribute('aria-disabled', 'true');
        });
      });
    }
  })();

  (function () {
    const btn = document.getElementById('btn-start-dep');
    const spin = document.getElementById('dep-spinner');
    const text = document.getElementById('dep-progress-text');
    const msg  = document.getElementById('dep-msg');
    const bar  = document.getElementById('dep-progress-bar');

    function resetDeparturesUI() {
      hideEl(spin);
      if (text) text.textContent = 'Preparazione…';
      if (msg)  msg.textContent  = '';
      if (btn)  btn.disabled = false;
      if (bar) {
        bar.style.width = '0%';
        bar.setAttribute('aria-valuenow', '0');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resetDeparturesUI);
    } else {
      resetDeparturesUI();
    }

    window.addEventListener('pageshow', function (e) {
      if (e.persisted) resetDeparturesUI();
    });
  })();
</script>

<style>
    .cta-row {
        display: flex;
        gap: .5rem;
        align-items: stretch;
    }

    .btn-same {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 .9rem !important;
        min-height: 44px;
        line-height: 1 !important;
        white-space: nowrap;
        margin: 0;
    }
</style>
{% endblock %}
