{% extends "base.html" %}
{% block title %}Booking{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Booking</h3>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('home.home') }}">Home</a>
    </div>

    <form id="bookingForm" method="get" action="{{ url_for('availability.search') }}" novalidate>
        <div class="row g-3">

            <!-- DEPARTURE AIRPORT -->
            <div class="col-12 col-md-6">
                <label class="form-label color-1" for="aptfrom">Departure airport</label>
                <select id="aptfrom" name="aptfrom" class="form-control form-select" title="Departure airport" data-live-search="true">
                    {% for val,label in airports %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- DESTINATION -->
            <div class="col-12 col-md-6">
                <label class="form-label color-1" for="destina">Destination</label>
                <select id="destina" name="destina" class="form-control form-select" title="Destination" required>
                    <option value="" selected disabled>Select destination</option>
                    {% for val,label in destinations %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Select a destination to see available departures.</div>
            </div>

            <!-- DATES + NIGHTS -->
            <div class="col-12">
                <div id="departuresCalendar" class="mb-2"></div>

                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Departure date</label>
                        <input type="date" id="start_date" name="start_date" class="form-control" readonly required>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Return date</label>
                        <input type="date" id="end_date" name="end_date" class="form-control" readonly>
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label">Nights</label>
                        <select id="nights" name="nights" class="form-control form-select">
                            <option value="7" selected>7</option>
                            <option value="14">14</option>
                        </select>
                    </div>
                </div>
                <div class="form-text">Highlighted dates are available departures for the selected destination.</div>
            </div>

            <!-- ROOMS & GUESTS -->
            <div class="col-12 col-lg-6">
                <label class="form-label color-1 d-block">Rooms & Guests</label>

                <!-- Riepilogo + pulsante sulla stessa riga -->
                <div class="d-flex align-items-center mb-2">
                    <div class="d-flex align-items-center gap-3 flex-wrap flex-grow-1">
                        <span><strong>Rooms:</strong> <span id="roomCount">1</span></span>
                        <span><strong>Adults:</strong> <span id="adultCount">2</span></span>
                        <span><strong>Children:</strong> <span id="childCount">0</span></span>
                    </div>

                    <!-- Trigger compatto, allineato a destra -->
                    <button type="button"
                            class="btn btn-outline-primary btn-sm ms-3"
                            id="paxBtn"
                            data-bs-toggle="modal"
                            data-bs-target="#paxModal"
                            aria-label="Edit rooms and guests">
                        Change Occupation
                    </button>
                </div>

                <!-- Hidden fields -->
                <input type="hidden" name="rooms" id="rooms" value="1">
                <input type="hidden" name="adults" id="adults" value="2">
                <input type="hidden" name="children_ages" id="children_ages" value="">
            </div>

            <!-- SUBMIT (tutto a destra) -->
            <div class="col-12 mt-2">
                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-secondary" type="reset" id="resetBtn">Reset</button>
                    <button class="btn btn-primary" type="submit">Search availability</button>
                </div>
            </div>


        </div><!-- row -->
    </form>
</div>

<!-- Shared spinner overlay -->
<div id="globalSpinner" class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(255,255,255,.6); z-index: 2000;">
    <div class="position-absolute top-50 start-50 translate-middle text-center">
        <div class="spinner-border" role="status" aria-label="Loading..."></div>
        <div class="mt-2 small text-muted">Searchingâ€¦</div>
    </div>
</div>

<!-- PAX Modal -->
<div class="modal fade" id="paxModal" tabindex="-1" aria-labelledby="paxModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paxModalLabel">Select rooms and guests</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row gy-3">
                    <div class="col-12 col-lg-2">
                        <label class="form-label d-block">Rooms</label>
                        <select class="form-select" id="roomsSel">
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                        </select>
                    </div>
                    <div class="col-12 col-lg-10" id="roomsContainer"><!-- filled by JS --></div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="text-muted me-auto small" id="paxError" style="display:none;"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyPax">Apply</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<style>
    #departuresCalendar td.selectable {
        cursor: pointer;
    }

    #departuresCalendar td.selected {
        outline: 2px solid rgba(0,0,0,.25);
        border-radius: .5rem;
    }

    #departuresCalendar td.fallback {
        background-color: rgba(13,110,253,.10);
    }

        #departuresCalendar td.fallback:hover {
            background-color: rgba(13,110,253,.18);
        }
</style>

<script>
    (() => {
        const $ = s => document.querySelector(s);
        const startInput = $('#start_date');
        const endInput = $('#end_date');
        const selDest = $('#destina');
        const selApt = $('#aptfrom');
        const selNights = $('#nights');
        const spinner = $('#globalSpinner');

        function showSpinner(on) { if (spinner) spinner.classList.toggle('d-none', !on); }
        function addDays(iso, d) { const x = new Date(iso); x.setDate(x.getDate() + (parseInt(d, 10) || 0)); return x.toISOString().slice(0, 10); }
        function dateKey(d) { const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), dd = String(d.getDate()).padStart(2, '0'); return `${y}-${m}-${dd}`; }

        const deps = new Set();     // date selezionabili
        const durMap = new Map();     // YYYY-MM-DD -> nights
        const aptMap = new Map();     // YYYY-MM-DD -> Set(IATA)
        const durSet = new Set();     // insieme durate disponibili (per rigenerare <select>)

        function rebuildNightsOptions() {
            const values = Array.from(durSet).filter(n => Number.isInteger(n) && n > 0);
            values.sort((a, b) => a - b);
            const fallback = [7, 14];
            const finalVals = values.length ? values : fallback;

            const current = selNights?.value || '';
            selNights.innerHTML = finalVals.map(v => `<option value="${v}">${v}</option>`).join('');
            if (current && finalVals.includes(parseInt(current, 10))) {
                selNights.value = current;
            } else {
                selNights.value = String(finalVals[0]);
            }
        }

        function pickIataLabel(val) {
            const s = (val || '').toString();
            const m1 = s.match(/\(([A-Z]{3})\)/g);
            if (m1 && m1.length) { const m = m1[m1.length - 1].match(/\(([A-Z]{3})\)/); if (m) return m[1]; }
            const m2 = s.match(/#([A-Z]{3})(\d)?\b/); if (m2) return m2[1];
            const m3 = s.match(/^\s*([A-Z]{3})\b/); if (m3) return m3[1];
            const m4 = s.match(/\b([A-Z]{3})\b/); if (m4) return m4[1];
            return s.replace(/[^A-Za-z]/g, '').slice(0, 3).toUpperCase();
        }
        function currentAptValue() {
            const v = (selApt?.value || '').trim();
            if (!v) return '';
            const m = v.match(/\b([A-Z]{3})\b/); if (m) return m[1];
            const m2 = v.match(/\b([A-Z]{3})\d\b/); if (m2) return m2[1];
            return v.replace(/[^A-Za-z]/g, '').slice(0, 3).toUpperCase();
        }

        let fp = null;
        function initFlatpickr() {
            if (fp) { fp.destroy(); fp = null; }
            const enabled = Array.from(deps).sort();
            fp = flatpickr(startInput, {
                dateFormat: "Y-m-d",
                disableMobile: true,
                allowInput: true,
                enable: enabled,
                showMonths: 2,
                inline: false,
                onOpen: () => startInput.blur(),
                onChange: (_, dateStr) => {
                    const dur = durMap.get(dateStr) || parseInt(selNights?.value || '7', 10) || 7;
                    if (selNights) selNights.value = String(dur);
                    endInput.value = dateStr ? addDays(dateStr, dur) : "";
                },
                onDayCreate: (_, __, ___, dayElem) => {
                    const iso = dateKey(dayElem.dateObj);
                    if (!deps.has(iso)) return;
                    dayElem.classList.add("available-day");
                    const dur = durMap.get(iso);
                    const apt = aptMap.has(iso) && aptMap.get(iso).size
                        ? Array.from(aptMap.get(iso)).join(', ')
                        : currentAptValue();
                    const bits = [];
                    if (apt) bits.push(apt);
                    if (dur) bits.push(`${dur} nights`);
                    dayElem.title = bits.join(' - ');
                }
            });
        }

        async function loadDepartures() {
            deps.clear(); durMap.clear(); aptMap.clear(); durSet.clear();
            startInput.value = ''; endInput.value = '';

            const dest = selDest?.value;
            if (!dest) { rebuildNightsOptions(); initFlatpickr(); return; }

            const qs = new URLSearchParams({ dest });
            const apt = selApt?.value;
            if (apt) qs.set('aptfrom', apt);

            try {
                const res = await fetch(`/availability/departures/by-dest?${qs}`, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                const rows = Array.isArray(json.rows) ? json.rows : [];

                rows.forEach(it => {
                    const dateIso = (it.date || it.depart_date || it.start_date || '').toString().slice(0, 10);
                    if (!dateIso) return;
                    deps.add(dateIso);

                    const dur = parseInt(it.duration_days ?? it.nights ?? it.duration ?? '', 10);
                    if (Number.isInteger(dur) && dur > 0) {
                        durMap.set(dateIso, dur);
                        durSet.add(dur);
                    }

                    const rawApt = it.depart_airport || it.airport || it.product_code || '';
                    const iata = pickIataLabel(rawApt) || currentAptValue();
                    if (iata) {
                        const set = aptMap.get(dateIso) || new Set();
                        set.add(iata);
                        aptMap.set(dateIso, set);
                    }
                });

                rebuildNightsOptions();
                initFlatpickr();

                // se esiste una sola durata, pre-selezionala
                if (durSet.size === 1) {
                    const only = Array.from(durSet)[0];
                    selNights.value = String(only);
                }
            } catch (e) {
                rebuildNightsOptions();
                initFlatpickr();
                console.error('[booking] departures load failed', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            rebuildNightsOptions();
            initFlatpickr();

            selDest?.addEventListener('change', loadDepartures);
            selApt?.addEventListener('change', () => { if (selDest?.value) loadDepartures(); });
            selNights?.addEventListener('change', () => {
                const s = startInput.value;
                if (s) endInput.value = addDays(s, selNights.value || "7");
            });

            if (selDest?.value) loadDepartures();

            const form = $('#bookingForm');
            form?.addEventListener('submit', (ev) => {
                if (!selDest?.value || !startInput?.value) {
                    ev.preventDefault();
                    alert('Please select a destination and a departure date.');
                    return;
                }
                const s = startInput.value;
                const dur = durMap.get(s) || parseInt(selNights?.value || '0', 10) || 0;
                if (dur && selNights) selNights.value = String(dur);
                if (s && dur && !endInput.value) endInput.value = addDays(s, dur);
                showSpinner(true);
            });

            window.addEventListener('pageshow', (ev) => {
                showSpinner(false);
                const nav = performance.getEntriesByType?.('navigation')?.[0];
                const fromBFCache = ev.persisted || (nav && nav.type === 'back_forward');
                if (fromBFCache) {
                    initFlatpickr();
                    if (selDest?.value) loadDepartures();
                    if (startInput?.value) {
                        const dur = durMap.get(startInput.value) || parseInt(selNights?.value || '7', 10) || 7;
                        selNights.value = String(dur);
                        endInput.value = addDays(startInput.value, dur);
                    }
                }
            });
        });
    })();
</script>






<style>
    .flatpickr-calendar {
        font-size: 12px;
    }

    .flatpickr-weekdays .flatpickr-weekday {
        font-size: 11px;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month .numInput.cur-year {
        font-size: 13px;
    }

    .flatpickr-days .dayContainer {
        justify-content: flex-start !important;
    }

    .flatpickr-day {
        width: calc(100%/7) !important;
        height: 26px;
        line-height: 26px;
        margin: 0 !important;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

        .flatpickr-day.available-day {
            background: transparent !important;
            border: none !important;
            color: #0a3622 !important;
        }

            .flatpickr-day.available-day::before {
                content: "";
                position: absolute;
                inset: 2px;
                border: 1px solid #198754;
                background: rgba(25,135,84,.30);
                border-radius: 6px;
                z-index: 0;
                pointer-events: none;
            }

        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
            background: #0d6efd !important;
            border-color: #0d6efd !important;
            color: #fff !important;
        }

            .flatpickr-day.selected.available-day::before,
            .flatpickr-day.startRange.available-day::before,
            .flatpickr-day.endRange.available-day::before {
                display: none !important;
            }
</style>
{% endblock %}
