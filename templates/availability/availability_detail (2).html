{% extends "base.html" %}
{% block title %}Availability – {{ product_name }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Availability – {{ product_name }}</h3>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('products.ota_product_detail', product_id=product_id) }}">← Back to product</a>
</div>

<p class="text-muted">Data: <strong>{{ start_date }}</strong> · Requested PAX: <strong>{{ units }}</strong></p>

{% if not avail.ok %}
<div class="alert alert-danger">Error: {{ avail.error_code }} – {{ avail.error_text }}</div>
{% endif %}

{% if avail.ok %}
  {% if avail.hotel %}
<div class="card mb-3">
    <div class="card-body d-flex gap-3">
        {% if avail.image_main %}
        <img src="{{ avail.image_main }}" class="rounded border" style="width:180px;height:auto" alt="">
        {% endif %}
        <div class="flex-grow-1">
            <h5 class="mb-1">{{ avail.hotel.tour_activity_name or product_name }}</h5>
            <div class="small text-muted">
                {{ avail.hotel.tour_activity_city_code }}
                {% if avail.hotel.category_detail %} · {{ avail.hotel.category_detail }}{% endif %}
                {% if avail.nights %} · {{ avail.nights }} notti{% endif %}
            </div>
        </div>
    </div>
</div>
  {% endif %}

<h5 class="mt-4">Camere e piani tariffari</h5>
  {% if avail.rooms %}
<div class="table-responsive">
    <table class="table table-sm table-striped table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Room</th>
                <th>Rate plan</th>
                <th>Meal</th>
                <th>Availability</th>
                <th>From</th>
                <th>To</th>
                <th>Nights</th>
                <th>Prices</th>
                <th style="min-width:180px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for r in avail.rooms %}
            <tr class="{% if r.availability_status and r.availability_status|lower not in ['available','onrequest'] %}table-light text-muted{% endif %}">
                <td>{{ r.name or '—' }}</td>
                <td>{{ r.rate_plan_name or r.rate_plan or '—' }}</td>
                <td>{{ r.meal_plan_codes or '—' }}</td>
                <td>{{ r.availability_status or '—' }}</td>
                <td>{{ r.start or start_date }}</td>
                <td>{{ r.end or '' }}</td>
                <td>{{ r.nights or avail.nights or '' }}</td>
                <td>{% if r.price %}<strong>{{ r.price }} {{ r.currency }}</strong>{% else %}—{% endif %}</td>

                <td>
                    {% if r.booking_code %}
                    <a class="btn btn-sm btn-primary"
                       href="{{ url_for('availability.availability_quote',
                        product_id=product_id,
                        booking_code=r.booking_code,
                        rate_plan_code=(r.rate_plan or r.rate_plan_name),
                        chain_code=(avail.hotel.chain_code or 'SANDTOUR'),
                        start_date=(r.start or start_date),
                        end_date=(r.end or start_date)) }}">
                        Ottieni quotazione
                    </a>
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </td>

            </tr>
            {% if r.cancel %}
            <tr class="table-secondary">
                <td colspan="9" class="small">
                    <strong>Penali:</strong>
                    Non rimborsabile: {{ r.cancel.non_refundable or '—' }}
                    · Deadline: {{ r.cancel.deadline.unit }} x {{ r.cancel.deadline.multiplier }} ({{ r.cancel.deadline.drop_time }})
                    · Penale: {{ r.cancel.penalty.percent or '—' }}% ({{ r.cancel.penalty.basis }})
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
  {% else %}
<div class="alert alert-warning">No rooms/opzion found.</div>
  {% endif %}
{% else %}
<div class="alert alert-warning">No valid response.</div>
{% endif %}

<hr class="my-4">

<div class="accordion" id="xmlAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="reqHead">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#reqCollapse"
                    aria-expanded="false" aria-controls="reqCollapse">
                XML Request
            </button>
        </h2>
        <div id="reqCollapse" class="accordion-collapse collapse"
             aria-labelledby="reqHead" data-bs-parent="#xmlAccordion">
            <div class="accordion-body">
                <pre class="m-0" style="white-space:pre-wrap">{{ request_xml|trim }}</pre>
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header" id="respHead">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#respCollapse"
                    aria-expanded="false" aria-controls="respCollapse">
                XML Response
            </button>
        </h2>
        <div id="respCollapse" class="accordion-collapse collapse"
             aria-labelledby="respHead" data-bs-parent="#xmlAccordion">
            <div class="accordion-body">
                <pre class="m-0" style="white-space:pre-wrap">{{ response_xml|trim }}</pre>
            </div>
        </div>
    </div>
</div>

<script>
    // Kill di qualsiasi listener globale che tenti di sottomettere form al click sui bottoni.
    // Capture = true: intercettiamo PRIMA di qualunque altro handler.
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.quote-btn');
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        // Se qualche lib prova a submit, non gli diamo scampo: forziamo la navigazione.
        // L'URL è già nell'onclick inline del bottone.
        // (Non serve altro qui.)
    }, true);
</script>


{% endblock %}
