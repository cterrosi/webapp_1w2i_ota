{% extends "base.html" %}
{% block title %}{{ product_name }}{% endblock %}

{% block content %}
<div class="container-xxl py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">{{ product_name }}</h3>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('home.home') }}">Home</a>
    </div>

    {# --- GALLERY --- #}
    {% if gallery and gallery|length %}
    <div id="productGallery" class="carousel slide mb-3" data-bs-touch="true" data-bs-interval="0">
        {% if gallery|length > 1 %}
        <div class="carousel-indicators">
            {% for url in gallery %}
            <button type="button"
                    data-bs-target="#productGallery"
                    data-bs-slide-to="{{ loop.index0 }}"
                    class="{% if loop.first %}active{% endif %}"
                    aria-current="{% if loop.first %}true{% endif %}"
                    aria-label="Slide {{ loop.index }}"></button>
            {% endfor %}
        </div>
        {% endif %}

        <div class="carousel-inner rounded border">
            {% for url in gallery %}
            <div class="carousel-item {% if loop.first %}active{% endif %}">
                <div class="ratio ratio-21x9">
                    <img src="{{ url }}" alt="Foto {{ loop.index }} di {{ product_name }}"
                         class="d-block w-100" style="object-fit: cover;">
                </div>
            </div>
            {% endfor %}
        </div>

        {% if gallery|length > 1 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#productGallery" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#productGallery" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
        {% endif %}
    </div>
    {% endif %}

    {# --- VOLI SELEZIONATI --- #}
    {% set out_legs = flights_selected | selectattr('od_rph','equalto','1') | list %}
    {% set in_legs  = flights_selected | selectattr('od_rph','equalto','2') | list %}
    {% if flights_selected and (out_legs|length or in_legs|length) %}
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between flex-wrap gap-2">
                <h5 class="mb-0">Selected flight</h5>
                <div class="text-end small">
                    {% if flight_vettore %}<div class="mb-1"><span class="badge text-bg-info">{{ flight_vettore }}</span></div>{% endif %}
                    {% if pp_price and pp_currency %}
                    <div class="fw-semibold">{{ pp_price }} {{ pp_currency }} <span class="text-muted">per person</span></div>
                    {% endif %}
                    <div class="text-muted">
                        {{ meta.request.destina }} from {{ meta.request.aptfrom or 'ANY' }},
                        {{ meta.request.start_date }} → {{ meta.request.end_date }} ({{ meta.request.nights }} nights)
                    </div>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-sm table-bordered align-middle mb-0">
                    <thead class="table-light">
                        <tr><th style="width:120px;">Direction</th><th>Segments</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="small">Outbound</td>
                            <td class="small">
                                {% if out_legs and out_legs|length %}
                                {% for f in out_legs %}
                                <div class="mb-1">
                                    {{ f.departure.airport }} → {{ f.arrival.airport }}
                                    <span class="text-muted">({{ f.flight_number }})</span><br>
                                    <span class="text-muted">
                                        <time class="dt" data-iso="{{ f.departure.datetime }}"></time> →
                                        <time class="dt" data-iso="{{ f.arrival.datetime }}"></time>
                                    </span>
                                    {% if f.baggage and (f.baggage.weight or f.baggage.unit) %}
                                    <span class="ms-2 badge text-bg-light">Bag: {{ f.baggage.weight }} {{ f.baggage.unit }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% else %}-{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="small">Inbound</td>
                            <td class="small">
                                {% if in_legs and in_legs|length %}
                                {% for f in in_legs %}
                                <div class="mb-1">
                                    {{ f.departure.airport }} → {{ f.arrival.airport }}
                                    <span class="text-muted">({{ f.flight_number }})</span><br>
                                    <span class="text-muted">
                                        <time class="dt" data-iso="{{ f.departure.datetime }}"></time> →
                                        <time class="dt" data-iso="{{ f.arrival.datetime }}"></time>
                                    </span>
                                    {% if f.baggage and (f.baggage.weight or f.baggage.unit) %}
                                    <span class="ms-2 badge text-bg-light">Bag: {{ f.baggage.weight }} {{ f.baggage.unit }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% else %}-{% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {# SCELTA CAMERA #}
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="mb-3">Choose your room</h5>

            {% if room_options and room_options|length %}

            {# ordina per prezzo crescente così, in caso di doppioni, vince il più economico #}
            {% set sorted_rooms = room_options|sort(attribute='total_price') %}
            {# set per deduplicare per booking_code #}
            {% set seen = {} %}

            <form id="quoteForm" method="post" action="{{ url_for('quote.create') }}">
                <!-- contesto ricerca -->
                <input type="hidden" name="start_date" value="{{ meta.request.start_date }}">
                <input type="hidden" name="end_date" value="{{ meta.request.end_date }}">
                <input type="hidden" name="nights" value="{{ nights }}">
                <input type="hidden" name="rooms" value="{{ meta.request.rooms }}">
                <input type="hidden" name="adults" value="{{ meta.request.adults }}">
                {% if meta.request.children_ages and meta.request.children_ages|length %}
                <input type="hidden" name="children_ages" value="{{ meta.request.children_ages|join(',') }}">
                {% endif %}
                <input type="hidden" name="currency" value="{{ meta.request.currency or 'EUR' }}">

                <div class="list-group">
                    {% for r in sorted_rooms %}
                    {% set code = r.booking_code %}
                    {% if not seen.get(code) %}
                    {# marca come visto: evita doppioni con stesso booking_code #}
                    {% set _ = seen.update({code: 1}) %}

                    <label class="list-group-item py-3">
                        <div class="d-flex justify-content-between gap-3">
                            <div class="d-flex gap-3">
                                <input class="form-check-input mt-1"
                                       type="radio"
                                       name="booking_code"
                                       id="rb_{{ loop.index }}"
                                       value="{{ r.booking_code }}"
                                       {% if loop.first or (r.room_code==(default_room_code|default(''))) %}checked{% endif %}>

                                <div>
                                    <div class="fw-semibold">
                                        {{ (r.room_name or r.room_code or 'Room')|upper }}
                                        {% if r.rate_plan_code %}
                                        <span class="text-muted">&nbsp;·&nbsp;<code>{{ r.rate_plan_code }}</code></span>
                                        {% endif %}
                                    </div>

                                    {# mostra SEMPRE il trattamento/rateplan #}
                                    {% if r.rate_plan_name or r.meal_plan_codes %}
                                    <div class="small">
                                        Meal plan:
                                        <span class="fw-semibold">{{ r.rate_plan_name or r.meal_plan_codes }}</span>
                                    </div>
                                    {% endif %}

                                    {% if r.room_code %}
                                    <div class="small text-muted">{{ r.room_code }}</div>
                                    {% endif %}

                                    <div class="mt-2 d-flex flex-wrap gap-2 small">
                                        {# refundable / non-refundable #}
                                        {% if r.non_refundable is not none %}
                                        <span class="badge text-bg-{{ 'danger' if r.non_refundable else 'success' }}">
                                            {{ 'Non-refundable' if r.non_refundable else 'Refundable' }}
                                        </span>
                                        {% endif %}

                                        {# policy di cancellazione (se presente) #}
                                        {% if r.cxl and r.cxl.deadline and (r.cxl.deadline.multiplier or r.cxl.deadline.unit) %}
                                        <span class="badge text-bg-secondary">
                                            CXL: {{ r.cxl.deadline.multiplier }} {{ r.cxl.deadline.unit }}
                                        </span>
                                        {% endif %}
                                        {% if r.cxl and r.cxl.penalty and (r.cxl.penalty.percent or r.cxl.penalty.basis) %}
                                        <span class="badge text-bg-secondary">
                                            Penalty: {{ r.cxl.penalty.percent }}% {{ r.cxl.penalty.basis }}
                                        </span>
                                        {% endif %}

                                        {# info volo (se agganciata alla tariffa) #}
                                        {% if r.flight and r.flight.booking_class %}
                                        <span class="badge text-bg-info">Class {{ r.flight.booking_class }}</span>
                                        {% endif %}
                                        {% if r.flight and r.flight.baggage and (r.flight.baggage.weight or r.flight.baggage.unit) %}
                                        <span class="badge text-bg-light">
                                            Bag {{ r.flight.baggage.weight }} {{ r.flight.baggage.unit }}
                                        </span>
                                        {% endif %}

                                        {% if r.pricing_type %}
                                        <span class="badge text-bg-light">{{ r.pricing_type }}</span>
                                        {% endif %}
                                    </div>

                                    {# mostra SEMPRE il booking code completo (no toggle “More details”) #}
                                    <div class="small mt-2 text-muted">
                                        Booking code: <code class="user-select-all">{{ r.booking_code }}</code>
                                    </div>
                                </div>
                            </div>

                            <div class="text-end">
                                <div class="fw-bold">{{ r.total_price }} {{ r.currency }}</div>
                                <div class="small text-muted">total stay</div>
                            </div>
                        </div>
                    </label>

                    {% endif %}
                    {% endfor %}
                </div>

                <div class="mt-3 text-end">
                    <button id="continueBtn" class="btn btn-primary" type="submit" data-loading-text="Processing…">
                        <span class="spinner-border spinner-border-sm me-1 d-none" role="status" aria-hidden="true"></span>
                        <span class="btn-text">Continue</span>
                    </button>
                </div>
            </form>

            {% else %}
            <div class="alert alert-warning mb-0">No rooms available for the selected package.</div>
            {% endif %}
        </div>
    </div>


    {# --- DEBUG / XML --- #}
    {% if request_xml or response_xml or meta %}
    <hr class="my-4">
    <div class="accordion" id="debugAccordion">
        {% if meta %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="dbgCtxHead">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dbgCtx" aria-expanded="false" aria-controls="dbgCtx">
                    Scelte (contesto)
                </button>
            </h2>
            <div id="dbgCtx" class="accordion-collapse collapse" aria-labelledby="dbgCtxHead"
                 data-bs-parent="#debugAccordion">
                <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered w-auto mb-0">
                            <tbody>
                                <tr><th>Dest</th><td>{{ meta.request.destina }}</td></tr>
                                <tr><th>APT from</th><td>{{ meta.request.aptfrom or '—' }}</td></tr>
                                <tr><th>Dates</th><td>{{ meta.request.start_date }} → {{ meta.request.end_date }} ({{ meta.request.nights }} nights)</td></tr>
                                <tr><th>Rooms/PAX</th><td>{{ meta.request.rooms }} / {{ meta.request.adults }}{% if meta.request.children_ages %} + chd {{ meta.request.children_ages|join(', ') }}{% endif %}</td></tr>
                                <tr><th>Currency</th><td>{{ meta.request.currency or 'EUR' }}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if request_xml %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="dbgReqHead">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dbgReq" aria-expanded="false" aria-controls="dbgReq">
                    XML Request
                </button>
            </h2>
            <div id="dbgReq" class="accordion-collapse collapse" aria-labelledby="dbgReqHead"
                 data-bs-parent="#debugAccordion">
                <div class="accordion-body">
                    <pre class="small bg-light p-2 border rounded xmlbox">{{ request_xml }}</pre>
                </div>
            </div>
        </div>
        {% endif %}

        {% if response_xml %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="dbgRespHead">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#dbgResp" aria-expanded="false" aria-controls="dbgResp">
                    XML Response
                </button>
            </h2>
            <div id="dbgResp" class="accordion-collapse collapse" aria-labelledby="dbgRespHead"
                 data-bs-parent="#debugAccordion">
                <div class="accordion-body">
                    <pre class="small bg-light p-2 border rounded xmlbox">{{ response_xml }}</pre>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

</div>

<script>
    (function () {
        try {
            const fmt = new Intl.DateTimeFormat(navigator.language || undefined, { dateStyle: 'medium', timeStyle: 'short' });
            document.querySelectorAll('time.dt[data-iso]').forEach(el => {
                const iso = el.getAttribute('data-iso');
                if (!iso) return;
                const d = new Date(iso);
                el.textContent = isNaN(+d) ? iso : fmt.format(d);
                el.title = iso;
            });
        } catch (e) { }
    })();
</script>

<script>
    (function () {
        try {
            const form = document.getElementById('quoteForm');
            if (!form) return;
            form.addEventListener('submit', function () {
                const btn = document.getElementById('continueBtn');
                if (!btn) return;
                btn.disabled = true;
                const spin = btn.querySelector('.spinner-border');
                if (spin) spin.classList.remove('d-none');
                const txt = btn.querySelector('.btn-text');
                if (txt) txt.textContent = btn.getAttribute('data-loading-text') || 'Processing…';

                // overlay anti-doppio click
                let ov = document.getElementById('submitOverlay');
                if (!ov) {
                    ov = document.createElement('div');
                    ov.id = 'submitOverlay';
                    ov.style.cssText = 'position:fixed;inset:0;z-index:1050;cursor:wait;pointer-events:auto;';
                    ov.className = 'bg-light bg-opacity-25';
                    document.body.appendChild(ov);
                } else {
                    ov.style.display = 'block';
                }
            });
        } catch (e) { }
    })();
</script>

<style>
    .xmlbox {
        white-space: pre-wrap;
    }
</style>
{% endblock %}
